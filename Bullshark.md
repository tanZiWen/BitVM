### 什么是部分同步网络？
部分同步网络（partially synchronous network）是分布式系统中的一种网络模型，介于完全同步和完全异步之间。它的特点如下：
1. 定义：在部分同步模型中，网络延迟有一个未知的上限（称为全局稳定时间，Global Stabilization Time，GST），但在 GST 之前，网络可能是异步的（消息可能无限延迟或丢失），而在 GST 之后，网络变为同步（消息会在某个已知时间内送达）。
与完全异步网络的区别：

1. 完全异步网络（如 DAG-Rider 和 Tusk 假设的模型）不假设任何消息延迟上限，协议必须在最坏情况下（无限延迟）保证安全性（一致性）和活跃性（持续确认事务）。
2. 部分同步网络假设网络最终会稳定（即 GST 后消息延迟有界），允许协议利用这一特性优化性能。
3. 实际意义：部分同步模型更贴近现实网络（如互联网），因为实际网络很少是完全异步的，通常会在某些条件下（如故障恢复后）恢复稳定。
4. 为什么延迟更低？ 在部分同步网络中，协议可以利用 GST 后的有界延迟，减少等待时间（timeout）或轮次，从而降低事务确认的延迟。Bullshark 正是针对这一特性进行了优化。

### Bullshark 如何优化部分同步网络
Bullshark 是基于 Narwhal 内存池和 DAG-Rider 的共识算法，专门针对部分同步网络进行了设计优化，以降低延迟并提升吞吐量。以下是其优化的核心机制：

a. 两轮波次与预定锚点（Anchors）
- 机制：
   - Bullshark 将 DAG 划分为每两轮一个波次（wave），每波次包含一个由预定领导者（leader）提出的锚点块（anchor block）。
   - 第一轮：验证者广播自己的块，包含事务和对前一轮至少2f+1个块的引用（ f 为最大拜占庭节点数）。
   - 第二轮：验证者广播块，引用第一轮的锚点块（由领导者提出），相当于对锚点投票。
   - 锚点块被至少2f+1个验证者引用后，被视为“认可”（committed），其包含的事务及其因果历史被排序。
- 部分同步优化：
   - 在部分同步网络中，Bullshark 假设 GST 后消息延迟有界（Δ），因此可以快速确认锚点块，而无需等待多轮投票或随机性生成。
   - 预定领导者的锚点机制减少了排序的复杂性，因为验证者只需要关注锚点块是否被足够多节点引用，而无需处理完全异步环境中的复杂随机性协调。
- 延迟降低：
  - 两轮波次设计比 Tusk 的三轮波次（提议、投票、随机性）更简洁，减少了确认事务所需的轮次。

在 GST 后，Bullshark 的确认延迟接近实际网络延迟（约 2-3 秒），而非完全异步协议（如 DAG-Rider 的 10+ 秒）中假设的最坏情况延迟。

b. 响应性（Responsiveness）

定义：响应性是指协议的确认延迟仅依赖于实际网络延迟，而非预设的最大延迟上限。
**Bullshark 的实现：**
1. 在部分同步网络中，Bullshark 通过快速确认锚点块实现响应性。一旦锚点块被 2f+1个验证者引用，协议立即推进排序，无需等待固定超时。
2. 对比完全异步协议（如 Tusk 或 DAG-Rider），后者需要额外的轮次来应对潜在的无限延迟，导致延迟较高。
**延迟降低：**
Bullshark 的响应性使其在 GST 后能充分利用网络的实际性能（例如，实际延迟可能是 500ms，而非假设的 2秒），从而将确认延迟降至 2-3 秒。

c. 零消息开销

**机制：**
1. Bullshark 的共识逻辑完全基于 Narwhal 的 DAG 结构。块的引用被视为提议和投票，排序通过本地 DAG 解释完成，无需额外的共识消息。
2. Narwhal 内存池确保事务的高效传播和因果历史的可靠存储，Bullshark 仅需在 DAG 上运行轻量级排序算法。
   
**部分同步优化：**
1. 在部分同步网络中，DAG 的构建速度更快（因为 GST 后消息延迟有界），验证者能更快地接收到 2f+1个块引用，从而加速锚点确认。
2. 零消息开销减少了通信轮次，相比需要多轮消息交换的协议（如 HotStuff），Bullshark 的延迟更低。
3. 延迟降低：避免了共识消息的往返时间（round-trip time），使 Bullshark 的延迟主要由 DAG 构建和锚点确认的时间决定，约为 2-3 秒。
4. 高效垃圾回收（Garbage Collection）

**机制：**
1. Bullshark 支持在同步期间清理旧轮次的块，减少 DAG 的内存占用。
2. 在部分同步网络中，Bullshark 利用 GST 后的有界延迟，确保所有诚实验证者能及时看到最新块，从而安全地执行垃圾回收。
   
**部分同步优化：**

1. 垃圾回收增强了公平性（慢节点的块在 GST 后仍能被包含），并减少了协议的等待时间。
2. 相比完全异步协议（如 Tusk），Bullshark 的垃圾回收更高效，因为它不需要假设无限延迟。
3. 延迟降低：高效的垃圾回收减少了 DAG 的处理开销，使协议能更快地推进新轮次，间接降低了确认延迟。
4. 延迟降低的具体表现，Bullshark 的延迟降低可以从以下数据和对比中理解：
   
**实验数据：**
1. 在广域网（WAN）环境中，Bullshark 结合 Narwhal 实现约 100,000-130,000 tx/sec 的吞吐量，延迟为 2-3 秒。
2. 相比之下，DAG-Rider 的延迟约为 10+ 秒，Tusk 的延迟为 3-4 秒，HotStuff 的延迟为 1-2 秒（但吞吐量仅 1,800 tx/sec）。
3. 
原因：
1. 两轮波次：减少了确认所需的轮次（2 轮 vs. Tusk 的 3 轮或 DAG-Rider 的更多轮）。
2. 响应性：延迟接近实际网络延迟（500ms-1 秒），而非假设的最大延迟（2-5 秒）。
3. 零消息开销：避免了额外通信的往返时间。
4. GST 利用：在部分同步网络中，Bullshark 在 GST 后快速稳定，减少了等待时间。
   
**与 Tusk 的对比：**
1. Tusk 针对完全异步网络，需额外轮次（随机性轮）来应对最坏情况（如无限延迟），导致延迟为 3-4 秒。
2. Bullshark 利用部分同步假设，在 GST 后无需这些额外轮次，延迟降低约 25%-50%（2-3 秒 vs. 3-4 秒）。

**与 HotStuff 的对比：**
1. HotStuff 是领导者驱动的 BFT 协议，延迟较低（1-2 秒），但吞吐量受限（1,800 tx/sec），因为它依赖单一领导者广播块。
2. Bullshark 的 DAG 结构允许多验证者并行提议块，吞吐量提升 50-100 倍（100,000+ tx/sec），但延迟略高（2-3 秒），因为 DAG 构建需要额外轮次。
   
**为什么部分同步优化能降低延迟？**
1. 部分同步网络的特性允许 Bullshark 做出以下假设和优化，从而降低延迟：
2. 有界延迟（GST 后）：Bullshark 可以在 GST 后快速确认锚点块，而无需为异步网络中的无限延迟预留冗余轮次。
3. 简化随机性：在部分同步网络中，Bullshark 的领导者选举和锚点确认更高效，因为它
4. 可以依赖网络的最终同步性，而非完全依赖随机币机制。
5. 快速收敛：GST 后，DAG 的构建和锚点投票能快速完成，减少了协议的等待时间。
**类比：**
1. 完全异步协议（如 Tusk）就像在暴风雨中航行，船必须为最坏情况（无限延迟）准备多余的燃料和时间。
2. Bullshark 在部分同步网络中就像在天气最终会晴朗的情况下航行，船可以在天气好转（GST）后加速，减少航行时间。

**Shoal 对 Bullshark 的进一步优化**

Aptos 实验室提出的 Shoal 框架进一步增强了 Bullshark 在部分同步网络中的延迟表现：
1. 流水线（Pipelining）：每轮引入锚点，允许多个共识实例并行运行，减少了排序的等待时间。
2. 领导者信誉（Leader Reputation）：优先选择最快的验证者作为领导者，减少因慢领导者导致的超时。
3. 普遍响应性（Prevalent Responsiveness）：确保延迟接近实际网络延迟，即使在高负载下。
结果：Shoal 将 Bullshark 的延迟降低高达 80%，在 Aptos 区块链上实现延迟低于 2 秒，吞吐量仍保持 100,000+ tx/sec。

**局限性与权衡**

尽管 Bullshark 在部分同步网络中显著降低了延迟，但仍有一些权衡：
1. 部分同步依赖：Bullshark 的低延迟依赖 GST 的发生。如果网络长时间处于异步状态（GST 延迟到达），延迟可能接近 Tusk 的水平（3-4 秒）。
2. DAG 构建成本：相比领导者驱动的协议（如 HotStuff，延迟 1-2 秒），Bullshark 的 DAG 构建引入了额外的轮次开销，导致延迟略高（2-3 秒）。
3. 公平性：在异步阶段，慢验证者的块可能被忽略，影响公平性（Bullshark 通过垃圾回收缓解此问题）。

### 总结
“Bullshark 优化了部分同步网络，延迟更低”的核心含义是：Bullshark 利用部分同步网络的特性（GST 后消息延迟有界），通过两轮波次、预定锚点、响应性和零消息开销等机制，显著降低了事务确认的延迟（2-3 秒，相比 Tusk 的 3-4 秒或 DAG-Rider 的 10+ 秒）。这些优化使 Bullshark 在吞吐量（100,000+ tx/sec）和延迟之间取得了更好的平衡，特别适合高性能区块链（如 Sui 和 Aptos）。
具体降低延迟的机制：
1. 两轮波次：简化了排序逻辑，减少轮次。
2. 响应性：延迟依赖实际网络延迟，而非最大延迟。
3. 零消息开销：避免了额外通信的往返时间。
4. 高效垃圾回收：加速 DAG 处理，间接降低延迟。

与 Tusk 和 DAG-Rider 的对比：
1. Tusk 和 DAG-Rider 针对完全异步网络，需额外轮次应对最坏情况，延迟更高。
2. Bullshark 在部分同步网络中利用 GST 的有界延迟，减少了冗余轮次，延迟降低 25%-80%

如果您想进一步探讨某机制（如锚点设计或 Shoal 的流水线），或需要数学推导（例如延迟分析或安全性证明），请告诉我！以下是推荐的进一步阅读：
   
Bullshark 论文：Spiegelman, A., et al., "Bullshark: DAG BFT Protocols Made Practical" (arXiv:2201.05677)。

Sui 文档：https://docs.sui.io/concepts/sui-concepts/consensus

Shoal 博客：https://medium.com/aptoslabs/shoal-how-we-reduce-bullshark-latency-on-the-aptos-blockchain-4f9b510e0b0b
