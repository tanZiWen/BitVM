## 你所需要的DAG #2 - Narwhal & Tusk

这是系列文章的第二篇，如果你还没有阅读第一篇文章，也不了解 **DAG Rider**，建议先阅读第一篇文章以全面理解 **Tusk**，因为它是 **DAG Rider** 的改进版本。原始论文由 George Danezis、Lefteris Kokoris-Kogias、Alberto Sonnino 和 Alexander Spiegelman 于 2022 年提出。

让我从我们试图通过 **Narwhal** 解决的问题开始讲起，这是一个重要的问题——将共识层与交易传播任务分离，从而形成一个高性能协议，即使在崩溃和异步期间仍能保持高吞吐量和活性。通常，部分同步协议（如 **LibraBFT** 和 **Hotstuff**）依赖于一个领导者（Leader）占用高带宽，而网络的其余部分在资源利用方面严重不足。**Narwhal** 通过分散资源利用来消除这种不均衡现象。

**Narwhal** 作为一个先进的交易池（Mempool），允许验证者运行多个工作机（worker machines）以并行化交易传播过程，并将每个工作机提供的数据批处理为子区块（sub-blocks），然后提供给主节点（Primary）。

![](https://miro.medium.com/v2/resize:fit:720/format:webp/1*xiMOYlWB8nsXE3JP6OJ-FA.png)

让我们定义一些抽象操作来帮助理解 **Narwhal** 的关键特性：

1. **写入操作** `write(d, b)`：将区块 `b` 和其摘要（唯一 ID）`d` 存储起来。写入操作会输出 `c(d)`，一个在成功写入操作后颁发的不可伪造的可用性证书。

2. **验证操作** `valid(d, c(d))`：如果证书有效则返回 `true`，否则返回 `false`。

3. **读取操作** `read(d)`：返回与摘要 `d` 关联的区块 `b`，前提是写入操作 `write(b, d)` 已经成功。

4. **因果读取操作** `read_causal(d)`：返回一个区块集合 `B`，该集合包含构成区块 `b` 因果历史的所有区块。

**Narwhal Mempool** 满足以下属性：

### 1. **完整性（Integrity）**
对于一个已认证的摘要 `d`，所有验证者通过 `read(d)` 返回的值相同，即每个区块的摘要都是唯一的。

### 2. **区块可用性（Block Availability）**
如果写入操作 `write(b, d)` 对于一个诚实方成功，则 `read(d)` 必须始终为所有参与方返回区块 `b`，即该区块对所有验证者可用。

### 3. **包含性（Containment）**
如果区块 `c` 是区块 `b` 的因果历史的一部分，那么 `c` 的所有因果历史也构成 `b` 的因果历史，并且是其一部分。

### 4. **2/3-因果性（2/3-Causality）**
区块 `b` 的因果历史中至少包含写入操作 `write(b, d)` 被调用之前提出的 2/3 区块。这是由于要求每个区块必须引用前一轮中的 `2f+1` 个区块。

### 5. **1/2-链质量（1/2-Chain Quality）**
区块 `b` 的因果历史中至少有 50% 的区块是由诚实验证者提出的。我们能够达到 1/2 的链质量，因为在构成区块 `b` 因果历史的 `2f+1` 区块中，最多有 `f` 个区块来自拜占庭验证者，剩余的 `f+1` 个区块则来自诚实验证者。

### **属性的重要性**
- **完整性和区块可用性**：将数据传播与共识分离。共识层只需对小尺寸的区块摘要证书进行排序，而不是完整区块，从而提高效率。
  
- **因果性和包含性**：即使在部分同步环境（如 **Hotstuff**）的异步期间，仍然能够保证高吞吐量。验证者可以继续提议区块和证书。一旦异步期结束，系统会自动排序当前区块及其因果历史，从而消除因异步导致的间隙。

### **可扩展性**
**Narwhal** 的另一个关键属性是可扩展性。它的吞吐量随着每个验证者所拥有的资源数量线性增长，同时不会对延迟造成影响。我们将在后续部分中详细解释其可扩展性特性。

### 设计 Narwhal

Narwhal 的设计直觉旨在：
1. **减少双重传输**：当领导者提议区块时，避免重复传输数据。
2. **支持扩展**：在更多资源可用时实现水平扩展。

**问题背景**：  
在大多数 Mempool 实现中，交易先通过 Mempool 共享，之后领导者创建一个区块并重新共享这些交易，这就导致了“双重传输”问题，Narwhal 旨在解决此问题。

### Narwhal 的 5 个关键设计步骤：

#### 1. **广播区块而非交易**
验证者直接广播区块，而领导者仅提议区块的哈希值，同时依赖 Mempool 层提供完整性保护的区块内容。此设计需要确保交易数据在任何需要时对所有验证者可用。

#### 2. **引入可用性证书**
为了确保数据可用性，领导者签发一个短证书，证明区块的可用性：
- 该证书由至少 `2f+1` 个验证者的签名构成，证明该区块已广播到这些验证者。
- 因为在 `2f+1` 个验证者中至少有 `f+1` 是诚实的，证书可以高度确保区块内容是可用的。
- **挑战**：当前每个 Mempool 区块需要一个证书。如果共识协议暂时失去活性，所需证书的数量可能无限增加。

#### 3. **因果性优化**
通过引入因果性，一个可用性证书可以引用多个 Mempool 区块及其完整因果历史：
- 领导者的带宽消耗大大降低。
- 即使共识延迟，Mempool 区块仍然可以持续生成并最终提交，从而避免因延迟对平均吞吐量的影响。

**存在的问题**：
1. **高速验证者滥用资源**：高速验证者可能通过快速生成区块迫使其他验证者执行大规模下载。
2. **带宽不足导致审查**：诚实验证者可能因带宽不足无法共享区块，进而被审查。

#### 4. **通过链质量限制区块生成速率**
为了解决上述问题，Narwhal 通过 **链质量（Chain Quality）** 施加限制：
- 即使验证者生成速度很快，也必须等待 `2f+1` 个区块生成后才能进入下一轮，其中至少有 `f+1` 是由诚实验证者生成的。
- 所有区块都必须引用前一轮的 `2f+1` 个区块，这再次保证了至少 `f+1` 个诚实区块被包含在其因果历史中。
- **优势**：Narwhal-Hotstuff 成为唯一在部分同步环境中提供抗审查能力的基于仲裁的协议。

#### 5. **支持水平扩展**
通过允许每个验证者使用多台工作机器共享 Mempool 子区块（称为批次），最终由一个主节点将这些引用整合到 Mempool 主区块中：
- 这种设计支持准线性扩展。
- 验证者可以投入更多的计算、存储和网络资源以共享交易。

### **总结**
Narwhal 是上述五个设计步骤的集大成者，将基础的 Mempool 设计演变为一个稳健且高效的数据传播和可用性层：
- **传统共识协议的优化**：Narwhal 可用于减轻 HotStuff 等传统共识协议的关键路径负担。
- **完全异步共识**：Narwhal 可利用包含性属性实现完全异步的共识。

### **区块提议和验证**
- 在本地轮次 `r` 中：
  - 验证者从客户端接收交易，并从其他验证者接收轮次 `r` 的可用性证书。
  - 验证者将交易和证书分别积累到交易列表和证书列表中。
  - 一旦接收到 `2f+1` 个来自轮次 `r` 的证书，验证者将其本地轮次推进到 `r+1`。
  
- 验证者广播自己创建的每个区块以确保其完整性和可用性：
  - 验证其他验证者的区块是否有效。
  - 如果有效，回复带有自己签名的确认。

在 Narwhal 中，一个有效的区块需要满足以下条件：

1. 包含创建者的有效签名。
2. 属于验证者正在检查的本地轮次 \( r \)（即相同轮次）。
3. 包含来自前一轮次 \( r-1 \) 至少 \( 2f+1 \) 个区块的证书。
4. 是该创建者在轮次 \( r \) 中提议的第一个区块（每个验证者每轮只能提议一个区块）。

如果一个区块有效，验证者会存储该区块并通过签署其区块摘要、轮次号以及创建者身份来确认其有效性。**准则交集**（quorum intersection）确保了区块的可用性和完整性（避免双重签名），因为在 2f+1 个签名中，至少有 f+1 个来自诚实验证者，这保证了在需要对交易排序时，区块可以被可靠地检索。

接下来，我们将探讨一个部分同步共识协议——**Hotstuff**，如何通过结合 **Narwhal** 提高其整体性能。
