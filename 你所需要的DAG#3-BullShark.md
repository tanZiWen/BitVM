## 你所需要的DAG#3-BullShark

欢迎来到本系列的第三篇文章，我们将探讨 **Bullshark**，一种拜占庭容错（BFT）共识机制。与其前辈 **DAG Rider** 和 **Tusk** 不同，Bullshark 不仅在异步环境下表现优异，同时还能充分利用同步网络的优势，实现同步与异步世界的最佳性能结合。

虽然 Tusk 在最坏情况下的异步环境中表现出色，即使在出现故障时也能提供最低延迟，但在最佳情况下的同步环境中却无法发挥其潜力，导致延迟高于现有协议。为了解决这一问题，Bullshark 提供了一条快速路径，利用常见的同步网络条件，同时在最坏情况下的异步环境中仍能表现出色。它不需要视图切换或视图同步机制。Bullshark 基于与 Tusk 相同的 DAG，因此继承了其可扩展性，能够在大规模委员会中保持高性能：在 50 个节点时实现每秒 125,000 笔交易，延迟约为 2 秒。此外，它还具备 Narwhal 的所有实用优势，如将数据传播与 DAG 构建分离，以及高效的可靠广播机制。

尽管 Tusk 提供垃圾回收功能，从而实现了有界的内存需求，但它牺牲了可量化的公平性。Bullshark 在同步阶段（即全球稳定时间 **GST** 之后）能够保证公平性。然而，由于在 GST 之前消息可能被无限期延迟，因此在异步阶段或 GST 之前，在有界内存需求下无法实现公平性。为此，在 GST 之前，Bullshark 采用了 Tusk 的重传策略，此时只能保证无限期执行的情况下达成协议。

Bullshark 遵循这样的趋势：一旦节点接收到至少 2f + 1 条消息，即可进入下一轮。在异步阶段，这种方式运行良好。然而，在同步阶段，恶意方可能会重新排序消息，迫使节点在收到领导者消息之前提前进入下一轮。为了解决这一问题，Bullshark 将超时嵌入 DAG，使得节点在超时发生之前会等待领导者的消息再进入下一轮。

---

### **Bullshark 的设计**

与 **DAG Rider** 类似，Bullshark 的两个核心模块是：
1. **可靠广播机制**：提供有效性（Validity）、一致性（Agreement）和完整性（Integrity）。
2. **全局完美随机数（Global Perfect Coin）**：为领导者的选举提供随机性，同时保证有效性、公平性、不可预测性和终止性。

这些属性已在第一篇文章（介绍 DAG Rider 时）中定义，建议先阅读该文章后再继续。

为了在同步和异步环境中都能充分发挥性能，Bullshark 在每一波次中设置了三位潜在的领导者。一个波次由连续四轮构成：
- **第 1 轮**：有两位潜在领导者，即备用领导者（Fallback Leader）和稳态领导者（Steady-State Leader）。
- **第 3 轮**：设置了另一位稳态领导者，以减少同步环境下的延迟。

因此，在同步环境下，只需要两轮即可确认稳态领导者。所有节点的投票类型在每一波次中都已预先定义，这确保了同一波次中不会同时确认备用领导者和稳态领导者。

---

### **投票规则**

1. **投票类型**：
   - 如果节点在上一波次中确认了备用领导者或第二位稳态领导者，其投票类型为“稳态”。
   - 如果节点在上一波次中未确认任何领导者，其投票类型为“备用”。
   - 借助可靠广播，即使是拜占庭节点也无法隐藏其投票类型。

2. **投票轮次**：
   - 第 2 轮的节点只能对第 1 轮的稳态领导者投票。
   - 第 4 轮的节点可根据其投票类型，对第 3 轮的第二位稳态领导者或第 1 轮的备用领导者投票。

---

### **性能分析**

1. **异步阶段**：
   - 每个备用领导者被确认的概率至少为 2/3，即在异步环境中，确认备用领导者平均需要 6 轮。

2. **同步阶段**：
   - 如果第一位领导者是诚实的，那么所有诚实节点将在第 3 轮几乎同时开始。
   - 无需视图切换，因为 DAG 已编码了所有保证安全性所需的信息。任何节点都可以通过 DAG 观察到其他节点的信息并据此做出决策。

3. **公平性**：
   - GST 之后，Bullshark 在同步阶段能保证公平性，即每个节点被选为领导者的概率相同。
**投票机制详解**

在 Bullshark 中，所有参与方都会维护两个列表：**steadyVoters[w]** 和 **fallbackVoters[w]**，用于记录某波次 w 中各方的投票类型。这取决于该方是否在上一波次 w-1 中确认了第二位稳态领导者、备用领导者，或者两者都未确认。

当某参与方 ) 在波次 w 的第一轮中广播一个顶点 v 时，其他参与方可以通过 v 的因果历史推断出 p 在波次 w 中的投票类型。这些因果历史包括了 v的强边所指向的顶点集，这些顶点被视为潜在的投票者。

- **确认波次 w-1 的备用领导者**：潜在投票者中至少有 2f+1 个顶点需要具备到该领导者的强路径，且其投票类型为备用类型。
- **确认波次 w-1 的第二位稳态领导者**：潜在投票者中至少有 2f+1 个顶点需要具备到该领导者的强路径，且其投票类型为稳态类型。
- **确认波次的第一位稳态领导者**：类似的，强路径的顶点需来自波次第三轮的顶点集。

由于可靠广播的特性，即使是拜占庭节点也无法伪造其投票类型。**仲裁交集（Quorum Intersection）** 能够保证在同一波次中，不同类型的领导者不会同时被确认。这就是为什么 Bullshark 要求至少 2f+1 条强路径，而不像 Tusk 那样只需要 f+1 条强路径即可保证安全性。

---

### 示例解析

假设 f = 1，以下是示例说明：
- **S1A**：波次 1 的第一位稳态领导者（第 1 轮）。
- **S1B**：波次 1 的第二位稳态领导者（第 3 轮）。
- **F1**：波次 1 的备用领导者（第 1 轮）。

所有参与方在波次 1 开始时，其投票类型均为稳态类型。

1. **第 2 轮**：  
   - P1 观察到 3 = 2f+1 条指向 **S1A** 的稳态投票（标记为红色），因此 P1 确认了 **S1A**。
   - P1 在第 4 轮仅观察到 1 条指向 **S1B** 的投票，因此 P1 未确认 **S1B**。

2. **波次 2 的投票类型变化**：  
   - 由于 P1 未确认波次 1 的第二位稳态领导者 **S1B**，它在波次 2 中的投票类型为备用类型。
   - 从 DAG 的第 5 轮观察得知，P2、P3 和 P4 也未确认 **S1B**，因此波次 2 中所有参与方的投票类型均为备用类型。

3. **第 8 轮**：  
   - P1 观察到 3 = 2f+1 条指向波次 2 备用领导者 **F2** 的备用投票（标记为蓝色），因此 P1 确认了 **F2**。

4. **回溯确认未确认的领导者**：  
   - P1 检查是否有未确认的领导者可以被确认。在第 4 轮，P1 仅观察到 1 条指向 **S1B** 的稳态投票（少于 f+1），因此 P1 不确认 **S1B**。因为如果 **S1B** 被某方确认，P1 应观察到至少 f+1 条投票。

通过上述机制，Bullshark 保证了在同步和异步环境下的协议安全性和一致性。
